stages:
- test

.prepare: &prepare
  stage: test
  image: iloveflamingo/buildenv:1.11
  cache:
    paths:
    - .dep
  before_script:
  - export DEPCACHEDIR=$(pwd -P)/.dep
  - mkdir ~/.ssh && echo -e "Host gitlab.aoe.com\n\tStrictHostKeyChecking no\n" >> ~/.ssh/config && echo "${GITLAB_SSH_KEY}" > ~/.ssh/id_rsa && chmod 400 ~/.ssh/id_rsa
  - mkdir -p "${GOPATH}/src/flamingo.me/"
  - export GODIR="${GOPATH}/src/flamingo.me/flamingo-commerce"
  - ln -sfv "$(pwd -P)" "${GODIR}"
  - /pact/pact-go_linux_amd64 daemon &
  - cd "${GODIR}"

cover:
  <<: *prepare
  script:
  - go test -coverprofile cover.out ./...
  - go tool cover -func cover.out

test:
  <<: *prepare
  script:
  - go test -race ./...

update:
  <<: *prepare
  script:
  - go test -race ./...
  allow_failure: true

static-check flamingo:
  <<: *prepare
  allow_failure: true
  script:
  - golint -set_exit_status $(go list ./...)
  - go vet ./...
  - gocritic check-project .

test 1.10:
  <<: *prepare
  image: iloveflamingo/buildenv:1.10
  script:
  - go test -race ./...
